# Lacework Terraform Automation Guide
This guide explains how to manage Lacework using Terraform infrastructure as code (IaC). The Lacework Terraform provider helps automate the management of Lacework. 

## Contents
| Demo | Description | Prerequisite Demos | Documentation |
|------|-------------|--------------------|---------------|
| **Lacework Terraform Provider Authentication** | Authenticate the Lacework Terraform provider, the first step to manage your Lacework account with IaC. | None | [README.md](./lacework-terraform-provider-authentication/README.md) |
| **Cloud Account Integrations** | Integrate your cloud accounts into Lacework. | Lacework Terraform Provider Authentication | [README.md](./cloud-account-integrations/README.md)
| **Container and Artifact Registry Integrations** | Integrate your container and artifact registries into Lacework. | Lacework Terraform Provider Authentication | [README.md](./container-and-artifact-registry-integrations/README.md) |
| **Resource Groups** | Manage resource groups within Lacework. | Lacework Terraform Provider Authentication | [README.md](./resource-groups/README.md) |
| **Alert Rules** | Manage alert rules for events generated by Lacework. | Lacework Terraform Provider Authentication | [README.md](./alert-rules/README.md) |
| **Alert Channels** | Create custom alert channels for notification of events generated by Lacework. | Lacework Terraform Provider Authentication, Alert Rules, Resource Groups | [README.md](./alert-channels/README.md)
| **Agent Deployments** | Enable and deploy agents within your workload environments. | Lacework Terraform Provider Authentication | [README.md](./agent-deployments/README.md) |


## Resources
| Resource | Format | Notes |
|----------|--------|-------|
| [Lacework Terraform Registry Documentation](https://registry.terraform.io/providers/lacework/lacework/latest/docs) | HTML | Covers authentication, organization and sub-account switching. |
| [Lacework CLI Documentation](https://docs.lacework.com/cli) | HTML | Covers installation, API key generation, and configuration of the Lacework CLI. |

## Prerequisites
| Item                                    | Description | Sections Required | Notes |
|-----------------------------------------|-------------|-------------------|-------|
| **Lacework account**                    | Multi-cloud security platform | *ALL* | If you do not have access to a Lacework account, you can visit [Lacework: Schedule a Demo](https://www.lacework.com/schedule-demo/) for ways to get started. |
| **Account level Lacework API key**      | An API key that has been created by a user with admin level privileges for the account or managing account | *ALL* | See [CLI Documentation: Create API Key](https://docs.lacework.com/cli#create-api-key) for details on how to create an API key. |
| **Organization level Lacework API key** | An API key that has been created by a user with admin level privileges for the account organization | [Organization Admin Configurations](./lacework-terraform-provider-authentication/README.md#organization-admin-configurations) | See [ Lacework CLI Documentation: Create API Key](https://docs.lacework.com/cli#create-api-key) for details on how to create an API key. |
| **Lacework CLI +v0.32.0**               | Open source tool for managing Lacework | *ALL* | See [Lacework CLI Documentation](https://docs.lacework.com/cli) for details on how to install the latest version of the tool.      |
| **Terraform**                           |  The Hashicorp infrastructure as code management tool | *ALL* | See [Install Terraform](https://learn.hashicorp.com/tutorials/terraform/install-cli) for details on how to install the Terraform binary. |

Before installing and authenticating the Lacework Terraform provider, it's important to understand:  
- *The difference between a Lacework account, organization, and its sub-accounts*
- *How best to source values for the Lacework provider configuration*

Before we discuss *how* to manage the Lacework platform, we'll discuss how accounts are structured within. For more detailed information on Lacework account structure, visit [Lacework Academy](https://academy.lacework.com) to see this video on [Initial Account Setup](https://academy.lacework.com/learn/video/initial-account-setup).

### The Lacework organization
The first part of this process entails installing and authenticating the Lacework Terraform provider to connect the IaC resources with the Lacework account (or accounts) you want to manage.

First in the hierarchy is the *organization level*. The organization is an elevated account that has an overall view of all the accounts contained within Lacework. This is why in the Lacework platform, the organization and first listed account share the same name. In the platform, the organization is denoted by "(Organization)" appearing after the name, and the primary account that was elevated to create the organization is denoted by "(Account)".

Users within the platform who have organization admin privileges can manage the organization itself, along with all accounts under the organization. These privileges also extend to API keys created by organization admin users. Using API keys created by an organization admin is required when managing the organization through IaC. It is also a convenient way to manage multiple accounts using a single API key. Configuring your IaC environment with a organization admin API key will allow the user to manage all of the organizations accounts as well.

### The Lacework account and sub-accounts
The Lacework account refers to the primary account used to access the Lacework platform. It has the property that its name is used in the URL created to access the platform as shown below.

`<your-account-name>.lacework.net`

Other accounts may also be associated with your primary Lacework account and will have a different name. These accounts are sub-accounts. The primary Lacework account and sub-accounts both have admin and user profiles. However, unlike with an organization profile, users and admins of accounts or sub-accounts can only access and manage features **within** that account or sub-account. This is also true of API keys created to manage the accounts through IaC.

## Managing provider configuration with the Lacework CLI
Although there are several ways to configure the Lacework provider, using the Lacework CLI to manage Lacework providers is the safest and easiest method. Documentation of how to install and use the CLI can be found on the [CLI Get Started](https://docs.lacework.com/cli) page.

### How it works
Once an account is set up with the Lacework CLI, a Lacework configuration TOML is generated and saved on the HOST machine as `.lacework.toml`, within a default directory<sup>1</sup>. An example TOML file is given below to illustrate the fields present. Within the Lacework TOML, **profiles** are specified in *section name* denoted by square brackets `[]`. Therefore, in this example, there are four profiles configured:
1. `primary`
1. `secondary-a`
1. `secondary-b`
1. `default`

![Example TOML File](./collateral/images/example-toml.png)

<sup>1</sup>*Reference the [CLI Get Started](https://docs.lacework.com/cli) documentation for more details on Lacework account configurations.*

The Lacework provider automatically searches for a Lacework TOML and uses it to populate the `account`, `api_key`, `api_secret`, and `subaccount` provider arguments if they have not been defined in the Terraform configuration file. All the fields are *optional*, because the Lacework Terraform provider will first search for the existence of the configuration TOML `.lacework.toml` file created by the Lacework CLI. More details about the provider arguments are in the [Lacework Provider Arguments](#lacework-provider-arguments) section where you will see all the values that can be configured.

To override any parameter sourced from the Lacework configuration *toml*, simply add the argument name and value within the provider block. Several examples are provided to illustrate this point in the section [Lacework Provider Configurations](#lacework-provider-configurations). The recommended option is to use the *default provider* or specify the account to manage using its **profile** name. Both of these options are covered in future sections.


# Getting started
There are two basic steps to get started with the Lacework Terraform provider:
1. Install the Lacework CLI
1. Install the Lacework Terraform provider

Additional resources and up-to-date references for the Lacework Terraform provider can be found on its registry page: [Lacework Terraform Registry](https://registry.terraform.io/providers/lacework/lacework/latest).

## Recommended installation
This section provides additional context and examples for using the provider for the first time.

### Step 1: Install the Lacework CLI
Detailed instructions on how to install the Lacework CLI are on the [Lacework CLI Docs: Get Started](https://docs.lacework.com/cli) page, including how to:
1. Download and install the Lacework CLI
1. Generate the required API secret and API key to enable use of the Lacework CLI

### Step 2: Install the Lacework provider
To begin with the Lacework Terraform provider, you must install the provider on your host machine. This can be achieved using this block of code:
```hcl
terraform {
  required_providers {
    lacework = {
      source = "lacework/lacework"
      version = "0.17.0"
    }
  }
}

provider "lacework" {
  # Configuration options
}
```
**Note**: *The `source` argument **MUST** be specified for the host to correctly point to the Lacework provider registry.*

The `required_providers` block **MUST** be specified as `lacework/lacework` to point to the Lacework Terraform registry.

Other providers may not need this explicit declaration of the provider's `source`. However, in those instances, Hashicorp is the owner of the provider; whereas for the Lacework provider, Lacework is the owner and maintainer.

Once this code is added to your Terraform configuration, you can run the command below to install the provider locally.
```sh
> terraform init
```

If you do not receive any errors when running the `terraform init` command, then you can now see `lacework/lacework` listed as an available provider when running the command below:
```sh
> terraform providers
```
An example output from this command looks like this:
```sh
Providers required by configuration:
.
└── provider[registry.terraform.io/lacework/lacework] 0.17.0
```

# Summary
After these steps are completed, you are ready to begin. 
